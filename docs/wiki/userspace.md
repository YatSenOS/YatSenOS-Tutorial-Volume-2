# 用户空间

# 用户态与内核态

从执行原理来说，不同进程的指令均运行在同一个处理器上，基于同一个处理器访问系统资源。但从资源管理、安全管理、崩溃预防的角度来看，操作系统需隔离敏感资源，限制不同进程的可以执行的指令以及它可以访问的地址空间范围。因此，现代操作系统通常会将进程分为两种状态：

- 用户态（user mode）：是指进程运行在低特权级别，只能执行受限指令，访问受限资源；
- 内核态（kernel mode）：是指进程运行在高特权级别，可以执行特权指令，并且可以直接访问所有系统资源。

用户态、内核态的区分有处理器提供硬件支持。处理器通常是用某个控制寄存器中的一个模式位（mode bit）来提供这种功能的存器描述了进程当前享有的特权。一个运行在内核态的进程可以执行指令集中的任何指令，并访问系统中的任何内存位置。

而用户态中的进程不允许执行特权指令（privileged instruction），比如停止处理器、改变模式位、发起一个 I/O 操作等。用户进程也不能直接访问高权限级的地址空间，**任何这样的尝试都会导致致命的保护异常，触发中断**。

!!! note "关于一般保护异常"

    一般保护异常（General Protection Fault，GPF）是操作系统在发现进程试图执行非法、未授权的或特权级别不足的操作时产生的一种异常。

用户程序必须通过内核态的介入，才能**间接地**访问敏感资源。进程可以通过一些特殊指令（如系统调用、中断）请求操作系统的服务，操作系统会在内核态中执行这些服务，然后返回结果给用户态。

相关数据的传递有一定的约束，这些被称为调用约定（calling convention）。调用约定规定了用户态和内核态之间的数据传递方式，包括参数传递、数据结构类型、返回值传递、异常处理等。

## Rings

在 x86_64 体系结构中，操作系统和应用程序运行在不同的特权级别（privilege levels）中，这些级别被称为 Rings。一般来说，较*低*的数字代表更*高*的特权级别：

- Ring 0：内核态，最高特权级别，可以执行所有指令，访问所有内存。
- Ring 1/2：被设计用于设备驱动程序和其他系统服务，但在现代操作系统中不再使用。
- Ring 3：用户态，最低特权级别，只能执行受限指令，需要访问受限资源时，必须通过系统调用等方式。

!!! question "为什么现代操作系统不使用 Ring 1/2？"

    1. **内存保护的粒度问题：** 虽然 x86 CPU 提供了四个特权级别，但对应特权只能在内存段粒度生效，而非现代操作系统所期待的更细粒度的内存保护。因此，现代大多数 x86 操作系统忽略段机制，而是依赖基于页表项（PTEs）的保护机制。而目前 x86 体系结构页表项的保护机制只有两个特权级别，即用户态和内核态。

    2. **可移植性问题：** 操作系统的设计者考虑需到跨平台的可移植性，不仅仅是限于 x86 架构。为了保持操作系统的可移植性，不依赖于特定处理器架构上的特权级别数量，而是统一使用两个特权级别，使得操作系统更易于在不同的处理器架构上移植和运行。

    3. **历史遗留问题：** x86 架构的设计早于现代操作系统的实现，许多 x86 的系统编程特性在设计时并不清楚操作系统将如何使用。随着现代操作系统对 x86 架构的深入了解和不断发展，许多早期设计的特性被现代操作系统所忽略，包括段机制和任务状态段等。对于 x64 架构，一些被废弃的特性被省略，使得操作系统可以更加简洁地设计和实现。

## 用户态库

<!-- 简单介绍 glibc / musl / msvcrt 等用户态库、暴露的 C 语言接口、为什么需要这样的设计等，参考实验任务文档中进行补充，重点讲解和科普 Linux 用户进程的生命周期 -->

## 参考资料

- [Getting to Ring 3 - OSDev](https://wiki.osdev.org/Getting_to_Ring_3)
- [Security - OSDev](https://wiki.osdev.org/Security)
- [Paging - OSDev](https://wiki.osdev.org/Paging)
- [Protection ring - Wikipedia](https://en.wikipedia.org/wiki/Protection_ring)
- [Computer Systems: A Programmer's Perspective - CSAPP](http://www.csapp.cs.cmu.edu/3e/home.html)
- [Why do x86 CPUs only use 2 out of 4 rings?](https://superuser.com/questions/1063420/why-do-x86-cpus-only-use-2-out-of-4-rings)
