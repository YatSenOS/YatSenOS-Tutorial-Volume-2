# APIC 可编程中断控制器

## 什么是 APIC

在 x86/x64 计算机体系结构中，高级可编程中断控制器（APIC）是一种关键的硬件组件，旨在管理和协调系统内的中断请求。

中断是计算机系统中的一种异步通信机制，用于响应外部事件，如设备状态变化、错误条件或其他重要的系统通知。随着计算机系统的发展和性能需求的提高，早期的中断控制器（如8259 PIC）逐渐显露出限制，特别是在多处理器系统的环境中。为了克服这些限制，高级可编程中断控制器（APIC）被引入，为计算机系统提供了更灵活、高效的中断处理机制。

APIC 不仅简单地分配中断向量，还提供了更为复杂的功能，如中断优先级、中断屏蔽、中断向量分发等。这使得它成为多处理器系统中协调中断处理的理想选择，并在大型、高性能的计算机系统中发挥关键作用。APIC 的作用不仅仅局限于中断处理，它还协助处理器间通信、同步和系统管理。通过提供多处理器系统中的高级中断控制和协同工作机制，APIC 极大地推动了操作系统和应用程序在复杂环境下的性能表现。

在本实验中，我们不会涉及到深入的 APIC 编程和使用，只需要专注于利用它实现基本的时钟中断和 I/O 设备中断。

## APIC 的初始化与编程

在基于 APIC 的系统中，每个 CPU 都由一个本地 APIC（LAPIC）控制。LAPIC 通过 MMIO（Memory Mapped I/O）方式映射到物理内存中的某个地址空间，这个地址空间称为 LAPIC 寄存器空间。同时，系统中还有一个 I/O APIC（IOAPIC），它是一个独立的芯片，负责管理系统中所有 I/O 设备的中断请求。I/O APIC 也通过 MMIO 方式映射到物理内存中的某个地址空间。

x2APIC 是 xAPIC 的变体和扩展，主要改进解决了支持的 CPU 数量和接口性能问题，他们都属于 LAPIC 的实现。在本实验中，我们将使用 xAPIC 来实现 LAPIC 的初始化和编程，在之后的描述中，出现的 APIC 均代指 xAPIC。

### APIC 的写入和读取



### APIC 的初始化

APIC 的初始化过程包括以下几个步骤：

- 禁用 8259 PIC，使得系统只使用 APIC 进行中断处理。这一步被 UEFI BIOS 自动完成，我们无需关心。
- 检测系统中是否存在 APIC，在 `x86_64` 中可以通过如下代码获知：

    ```rust
    CpuId::new().get_feature_info().map(
        |f| f.has_apic()
    ).unwrap_or(false)
    ```

- 确定 APIC 的地址空间，即 LAPIC 和 IOAPIC 的 MMIO 地址空间，由于我们采用了虚拟地址空间，所以这里需要进行地址映射，将物理地址映射到虚拟地址空间中。
- 将 SIVR（Spurious Interrupt Vector Register, 0xF0）寄存器的第 8 比特置为 1，保留其他位，启用中断功能。
-


## 参考资料

- [APIC - OSDev](https://wiki.osdev.org/APIC)
